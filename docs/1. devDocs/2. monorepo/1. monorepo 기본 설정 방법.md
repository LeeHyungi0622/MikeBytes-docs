# 1. Monorepo 구성

## pnpm 설치

**pnpm (Performance Node Package Manager)** 는 개별 프로젝트 단위가 아닌, **전역적으로 Node 관련 패키지를 효율적으로 관리** 하는 패키지 매니저다.

Mac에서는 Homebrew를 사용해 설치할 수 있다.

```zsh
brew install pnpm
```

## 디렉토리 구조

향후 확장성, 재사용성, 그리고 공통화 등을 고려하여 **server-side도 세분화된 package 단위** 로 구성한다.

```yaml
- packages/
  - 1. Common/  # 공통 유틸리티 및 공유 모듈
  - 2. Client
    - hmi-client-police-patrol-car/  # 순찰차 HMI 클라이언트
    - hmi-client-police-patrol-robot/  # 순찰로봇 HMI 클라이언트
  - 3. Server/  # 백엔드 서버
- .gitignore
- .dockerignore
- pnpm-workspace.yaml
- README.md
```

## pnpm-workspace.yaml 설정

`pnpm-workspace.yaml`은 monorepo 내에서 관리할 개별 패키지를 정의하는 파일이다. 아래 설정을 통해 `packages/` 하위의 모든 디렉토리를 패키지로 인식하도록 한다.

```yaml
packages:
  - "packages/**"
```

## .dockerignore 설정

Docker 빌드시 불필요한 파일이 포함되지 않도록 `.dockerignore`를 설정한다.

```dockerignore
**/node_modules
out/ # turbo prune 명령을 통해 제외된 package.json 파일이 위치하는 디렉토리
```

위 설정은 **루트 디렉토리뿐만 아니라 하위 패키지의 `node_modules` 디렉토리도 복사되지 않도록 제외**하는 역할을 한다.

## pnpm 설치 및 초기 설정

### 1. `pnpm install` 실행 전 준비

`pnpm install`을 실행하기 전에, `packages/` 하위 디렉토리 중 **최소 하나 이상이 프로젝트 코드로 구성되어 있어야 한다**.
그렇지 않으면 `pnpm-lock.yaml`과 `node_modules/` 디렉토리가 정상적으로 생성되지 않는다.

### 2. pnpm 설치 명령 실행

```zsh
pnpm install
```

명령 실행 후, `node_modules/` 디렉토리가 생성되며,
해당 디렉토리 내부에서 `.pnpm-workspace-state.json` 파일을 확인할 수 있다.

이 파일에는 **각 패키지 단위의 root 디렉토리 정보가 저장**된다.

### 3. 각 패키지의 `package.json`에 pnpm 버전 명시

설치된 `pnpm`의 버전을 확인한 후, 각 패키지의 `package.json` 파일에 이를 명시해야 한다.

```zsh
# pnpm 버전 확인
pnpm -v
```

각 패키지(`packages/*`)의 `package.json` 파일에 아래와 같이 추가한다.

```json
{
  "packageManager": "pnpm@x.x.x"
}
```

### 4. Symbolic Link 문제와 Docker 빌드

`pnpm install` 실행 후, `packages/` 하위의 각 패키지는 **workspace 루트의 모듈들을 symbolic link 방식으로 참조**하게 된다.

그러나 **Docker 빌드 과정에서는 symbolic link를 통한 참조가 실행 환경에 따라 다르게 동작할 수 있으며, 이로 인해 빌드 오류가 발생할 수 있다**.

> Docker는 항상 동일한 빌드 결과를 보장해야 하지만, symbolic link는 OS 및 파일 시스템에 따라 다르게 동작할 수 있어 빌드 과정에서 에러가 발생할 수 있음.

이를 방지하기 위해, `.dockerignore`에 `**/node_modules`를 추가하여 **모든 패키지의 `node_modules` 디렉토리를 복사하지 않도록 설정**했다.

---

이제 `pnpm`을 활용한 monorepo 기본 구성이 완료!
